var ConstantsMap={headerUrl:"",storage:window.localStorage,wsdkUrl:"https://g.alicdn.com/aliww/h5.imsdk/2.1.4/scripts/yw/wsdk.js"},MessageType={text:0,img:1,voice:2},StorageKey={imPageOpened:"imPage",initParamKey:"initParamKey",unReadMsgSum:"unReadMsgSum",isClosed:"isClosed",isFocus:"isFocus",chatWithUid:"chatWithUid",topUrl:"topUrl"},ImConstants=function(){function o(o,e){if(null!=e&&!document.getElementById(o)){var t=document.getElementsByTagName("HEAD").item(0),i=document.createElement("script");i.type="text/javascript",i.id=o,i.text=e;var n=t.getElementsByTagName("script");n.length>0?t.insertBefore(i,n[0]):t.appendChild(i)}}function e(e,t){$.ajax({type:"GET",url:t,async:!1,success:function(t){o(e,t)}})}return{checkIsTrue:function(o,e,t){var i=o.sys_id,n=o.sys_name,a=o.time,s=o.token;return void 0==i||void 0==n||void 0==a||void 0==s||""==i||""==n||""==a||""==s?(console.log("缺少必要参数"),!1):void $.get(ConstantsMap.headerUrl+"/monk/chat/checkApp",{sysId:i,sysName:n,time:a,token:s},function(o){o.success?void 0!=e&&e(o):void 0!=t&&t(o)})},getUsersData:function(o,e,t,i){$.get(ConstantsMap.headerUrl+"/monk/chat/getUser",{sysId:o,sysName:e},function(o){o.success?void 0!=t&&t(o):void 0!=i&&i(o)})},includeJs:function(o,t){e(o,t)}}}(),sId="wsdk",url=ConstantsMap.wsdkUrl;ImConstants.includeJs(sId,url);var NotifyUtil=function(){var o=3e3;return{sendNotify:function(e,t){e||t||(e="桌面提醒",t="您看到此条信息桌面提醒设置成功");var i=ConstantsMap.headerUrl+"/img/logo/im_80_80.png",n='<audio id="im_audio_mp3" autoplay="autoplay"><source src="'+ConstantsMap.headerUrl+'/img/taoqi.mp3" /></audio>';if($("body").append(n),setTimeout(function(){$("#im_audio_mp3").remove()},1500),window.webkitNotifications)if(0==window.webkitNotifications.checkPermission()){var a=window.webkitNotifications.createNotification(i,e,t);a.display=function(){},a.onerror=function(){},a.onclose=function(){},a.onclick=function(){this.cancel()},a.replaceId="Meteoric",a.show()}else window.webkitNotifications.requestPermission(notify);else if("Notification"in window)if("granted"===Notification.permission){var s=new Notification(e,{icon:i,body:t});s.onshow=function(){setTimeout(function(){s.close()},o)}}else"denied"!==Notification.permission&&Notification.requestPermission(function(n){if("permission"in Notification||(Notification.permission=n),"granted"===n){var a=new Notification(e,{icon:i,body:t});a.onshow=function(){setTimeout(function(){a.close()},o)}}})}}}(),TimChat=function(){function o(){void 0==$("#chat_from_monk_modal").html()&&$("body").append(_.replace(/MonkHeaderUrl/g,ConstantsMap.headerUrl));var o=$("#chat_from_monk_modal");document.documentElement.clientHeight;o.addClass("in");var e=o.parent().parent();o.find(".modal-section").unbind("click").click(function(){return!1}),o.find(".model-close").unbind("click").click(function(){return e.remove(),o.removeClass("in"),!1}),o.parent().unbind("click").click(function(){return e.remove(),o.removeClass("in"),!1})}function e(o,e,t){void 0!=o&&(p=o),void 0!=e&&(g=e),M.Base.login({uid:p,appkey:m,credential:g,timeout:864e5,success:function(o){void 0!=t&&t()},error:function(o){}})}function t(o){void 0!=o&&(h=o),M.Base.getUnreadMsgCount({count:10,success:function(e){void 0!=o&&o(e)},error:function(o){1001==Number(o.code)&&e(void 0,void 0,t)}})}function i(o){var e=o.sys_id,t=o.sys_name,i=o.time,n=o.token;return void 0==e||void 0==t||void 0==i||void 0==n||""==e||""==t||""==i||""==n?(console.log("缺少必要参数"),alert("初始化 淘汽云聊失败，缺少必要参数"),!1):!0}function n(o,e){if(void 0!=o&&(f=o),void 0!=f){var t=f.data,i=t.aliUid,n=t.aliPassword;m=t.appKey,v=e,void 0==k&&(k=StorageKey.imPageOpened+t.sysId+t.sysName);var s=ConstantsMap.storage.getItem(k);if(void 0==s)a(i,n);else{var r=ConstantsMap.storage.getItem(k+StorageKey.unReadMsgSum);d(r)}var c=window.setInterval(function(){var o=ConstantsMap.storage.getItem(k);void 0==o?a(i,n):window.clearInterval(c)},2e4)}}function a(o,t){void 0==y?(y=1,e(o,t,s)):s()}function s(){t(function(o){var e=o.data,t=0;$.each(e,function(o,e){t+=e.msgCount}),t!=w&&(w=t,void 0!=v&&0!=Number(t)&&v(t,!1))})}function d(o){void 0!=o&&o!=w&&void 0!=v&&(w=o,v(o,!0))}function r(){var o=function(o){var e=o.key,t=o.newValue;return void 0==k?!1:(e==k&&(void 0==t?(U=!0,setTimeout(function(){U&&(ConstantsMap.storage.clear(),n(f,v))},3e3)):U=!1),void(e==k+StorageKey.unReadMsgSum&&d(t)))};window.removeEventListener("storage",o),window.addEventListener("storage",o)}function c(){void 0!=C?C.focus():void 0!=k&&ConstantsMap.storage.setItem(k+StorageKey.isFocus,"1")}function l(){ConstantsMap.storage.setItem(k+StorageKey.isClosed,"1")}function u(o,e,t){""!=t&&ConstantsMap.storage.setItem(k+StorageKey.topUrl,t),ConstantsMap.storage.setItem(k+StorageKey.chatWithUid,e+","+o)}var m,v,f,p,g,h,y,w=0,C=void 0,k=void 0,_='<div id="all_chat_hold"><div class="chat_from_monk_modal-scrollable"><div id="chat_from_monk_modal" class="monk_chat_modal modal fade modal-scroll" tabindex="-1" data-keyboard="false" aria-hidden="true" style="top:0px; margin-top: 0px; display: block;">  <a href="#" class="model-close btn red" data-dismiss="modal" aria-hidden="true">  <img src="MonkHeaderUrl/img/other/portlet-remove-icon-white.png">  </a>  <div class="modal-section">  <div class="modal-header" >  <h4 class="modal-title">聊天页面被拦截，需要手动调整，操作如下：</h4>  </div>  <div class="modal-body">  <div class="cut_show" style="height:600px !important;">  <div><span>第一步：找到网址输入框最右侧的拦截图标</span></div>  <div><img src="MonkHeaderUrl/img/hold/1-find.png"></div>  <div><span>第二步：点击拦截图标，选择始终允许</span></div>  <div><img src="MonkHeaderUrl/img/hold/3-choose.png"></div>  <div><span>第三步：点击聊天页面地址，打开聊天页面</span></div>  <div><img src="MonkHeaderUrl/img/hold/4-open.png"></div>  </div>  </div>  </div> </div> </div> <div class="modal-backdrop fade in"></div></div>',M=new WSDK,U=!0;return{initOpenChatPage:function(e,t){var n=e.header_url;if(void 0==n)return console.log("必须传接入的地址前缀"),!1;if(ConstantsMap.headerUrl=n,i(e)){var a=e.sys_id,s=e.sys_name;k=StorageKey.imPageOpened+a+s;var d=ConstantsMap.storage.getItem(k);if(void 0==d)void 0!=a&&void 0!=s&&ImConstants.getUsersData(a,s,function(t){var i=t.data;m=i.appKey;var n=e.opened_url;ConstantsMap.storage.setItem(StorageKey.initParamKey,JSON.stringify(e)),C=window.open(n,"monk-chat","width="+(window.screen.availWidth-30)+",height="+(window.screen.availHeight-30)+",top=0,left=0,toolbar=no,menubar=no,scrollbars=no, resizable=no,location=no, status=no"),r();var a=k+"refuse";ConstantsMap.storage.setItem(a,"0"),setTimeout(function(){var e=ConstantsMap.storage.getItem(a);void 0!=e&&0==Number(ConstantsMap.storage.getItem(a))&&o()},3e3)});else{c();var l=e.to_sys_id,v=e.to_sys_name;void 0!=l&&void 0!=v&&ImConstants.getUsersData(l,v,function(o){var t=o.data;u(l,t.aliUid,e.top_url)}),void 0==t&&(t=function(){console.log("当前用户的聊天页面已打开~~~请直接到聊天页面查看")}),t()}}},initGetNewMessage:function(o,e){var t=o.header_url;if(void 0==t)return console.log("必须传接入的地址前缀"),!1;ConstantsMap.headerUrl=t;var a=function(o){NotifyUtil.sendNotify("尊敬的客户，你好","您有"+o+"条未读消息，请及时打开右侧淘汽车信入口进行查看")};void 0==e&&(e=a),i(o)&&ImConstants.checkIsTrue(o,function(o){n(o,e)})},closeChatWindow:function(o,e){var t=$(window.parent.document).find(".main_chat_section").html();void 0==t?(void 0!=o&&void 0!=e&&(k=StorageKey.imPageOpened+o+e),l()):$(window.parent.document).close()},focusChatWindow:function(){c()},notify:function(o,e){NotifyUtil.sendNotify(o,e)}}}();"function"==typeof define&&define("TqmallIm",[],function(){return{Chat:TimChat}});