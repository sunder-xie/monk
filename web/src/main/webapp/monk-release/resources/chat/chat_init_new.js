function beforeChangePeople(e){$.isFunction(e)&&(beforeChangePeople_func=e)}function initClick(){$("#clear_search_people_input").click(function(){$("#search_people").val(""),$(this).addClass("hidden"),$(".people_li").removeClass("hidden"),$("#search_people").focus()}),$("#search_people").keyup(function(){var e=$(this).val(),t=e.trim(),n=t.length;e.length!=n&&$(this).val(t);var i=$("#clear_search_people_input");if(0==n)i.addClass("hidden"),$(".people_li").removeClass("hidden");else{i.removeClass("hidden");var a=t.toUpperCase();$(".people_li").addClass("hidden"),$.each($(".people_li"),function(e,t){var n=$(t).data("name").toUpperCase();n.indexOf(a)>-1&&$(t).removeClass("hidden")})}}),$(".expand_btn").unbind("click").click(function(){var e=($("#expand_bottom_iframe"),$("#expand_main"));$(".chat_content").addClass("expand"),$("#expand_bottom").addClass("hidden"),$("#expand_bottom_close").removeClass("hidden"),e.show("slow"),to_chat_bottom(),$("#new_message_area").focus()}),$(".expand_btn_close").unbind("click").click(function(){$("#expand_bottom").removeClass("hidden"),$("#expand_bottom_close").addClass("hidden"),$(".chat_content").removeClass("expand"),$("#expand_main").hide("slow"),$("#new_message_area").focus()}),$("#monk_alert_model .model-close").unbind("click").click(function(){MMDChat.alertHide()}),$("#monk_pic_model .model-close").unbind("click").click(function(){MMDChat.alertImgHide()}),$(".chat_main").scroll(function(){if($(".chat_main").scrollTop()<=0){var e=$("#chat_main_div .chat_msg_wrap").length;if(""==$("#loading").html()&&e>0){var t=$(".people_li.active").data("uid");get_history(t,next_key_map[t])}}}),$("#monk_pic_model").click(function(){MMDChat.alertImgHide(),$("#new_message_area").focus()}),$("#model_img").click(function(){return!1})}function windowChange(){$(window).unload(function(){onbeforeunload()}),$(window).resize(function(){initCss()}),$(window).load(function(){NotifyUtil.sendNotify("淘汽车信","欢迎您的到来~~~")})}function onbeforeunload(){param&&ConstantsMap.storage.setItem(StorageKey.initParamKey,JSON.stringify(param)),ConstantsMap.storage.removeItem("__WSDK__"),ConstantsMap.storage.removeItem(pageKey),ConstantsMap.storage.removeItem(pageKey+"refuse"),ConstantsMap.storage.removeItem(pageKey+StorageKey.isClosed),ConstantsMap.storage.removeItem(pageKey+StorageKey.isClosed)}function windowClose(){onbeforeunload(),ConstantsMap.storage.clear(),window.close()}function initCss(){changeBodyHeight();var e=$(".people_ul"),t=$(".chat_people").height(),n=0;$.each(e.siblings(),function(e,t){n+=$(t).outerHeight()});var i=(t-n)/t*100;e.height(i+"%"),fontCss()}function fontCss(){MMDChat.isMac()&&($("span").css("font-family",'"Helvetica","Microsoft YaHei"'),$("pre").css("font-family",'"Helvetica","Microsoft YaHei"'))}function changeBodyHeight(){var e=document.documentElement.clientHeight,t=$("body"),n=t.css("min-height");t.css("height",e+"px"),Number(e)<Number(n.replace("px",""))?t.css("overflow-y","auto"):t.css("overflow-y","hidden"),$("#monk_pic_model").css("max-height",e+"px"),$("#monk_pic_model").height()+10>e?$("#monk_pic_model").css("top","0%"):$("#monk_pic_model").css("top","50%")}function initCheck(){param=JSON.parse(ConstantsMap.storage.getItem(StorageKey.initParamKey)),void 0==param&&(MMDChat.alertFunc("参数错误或登录超时，5秒后将关闭窗口，请重新打开聊天框"),setTimeout(function(){windowClose()},5e3)),ConstantsMap.headerUrl.indexOf(online_url)>-1&&(is_the_test=!1),pageKey=StorageKey.imPageOpened+param.sys_id+param.sys_name,error_func(),ConstantsMap.storage.setItem(pageKey+"refuse","2"),ConstantsMap.storage.setItem(pageKey,"opened"),ImConstants.checkIsTrue(param,function(e){nowUserDO=e.data,aliUid=nowUserDO.aliUid,$("#aliuid").val(aliUid);var t=param.top_url;t&&$("#top_url").val(t),StoryListener(),initAliYunWang()},function(e){console_func("wrong fail to check"),MMDChat.alertFunc("出错啦~"+e.message+" 5秒后关闭窗口"),setTimeout(function(){windowClose()},5e3)})}function initAliYunWang(e){var t=nowUserDO.aliUid,n=nowUserDO.aliPassword,i=nowUserDO.appKey;logout_func=sdk.Base.logout,$.isFunction(logout_func)&&!first_init_yunwang?sdk.Base.logout({success:function(a){console_func("log out success"),console_func(a),log_out_index=0,yunwangLogin(t,n,i,e)},error:function(t){console_func("log out error"),console_func(t),log_out_max_num>log_out_index?log_out_index++:(log_out_index=0,first_init_yunwang=!0),initAliYunWang(e)}}):(first_init_yunwang=!1,yunwangLogin(t,n,i,e))}function yunwangLogin(e,t,n,i){setTimeout(function(){login_500&&(MMDChat.unblockUI(),MMDChat.alertFunc("网络出现异常，请刷新或退出重新打开该页面"))},15e3),sdk.Base.login({uid:e,appkey:n,credential:t,timeout:12e4,success:function(e){console_func("login success",e),login_500=!1,i?i():base_ali_func()},error:function(e){console_func("login fail",e),login_500=!1;var t=Number(e.code);error_func(t),1008==t?finalTry(i):1002==t?MMDChat.alertFunc("登录超时，请刷新后重试"):initAliYunWang(i)}})}function base_ali_func(){timeTask(),void 0==is_first_yunwang?(opened_time=(new Date).getTime(),recentContact()):(getUnReadMessageNum(),getNowChatContentAppend())}function timeTask(){ali_task&&window.clearInterval(ali_task),allMessageListenser(),ali_task=window.setInterval(function(){errorRetry(),getNowChatContentAppend(),allMessageListenser()},2e4)}function error_func(e,t){ConstantsMap.storage.removeItem("debug"),ConstantsMap.storage.removeItem("__WSDK__"),t&&1005==e&&MMDChat.alertFunc("网络出现问题，请检查网络后重试")}function finalTry(e){sdk.Base.getRecentContact({count:1,success:function(t){console_func("final success",t),e&&e()},error:function(e){console_func("final fail",e)}})}function errorRetry(){sdk.Base.getUnreadMsgCount({count:1,success:function(e){console_func("errorRetry success",e)},error:function(e){console_func("errorRetry fail",e);var t=Number(e.code);error_func(t),1001==t&&initAliYunWang()}})}function recentContact(){sdk.Base.getRecentContact({count:100,success:function(e){console_func("get recent contact success",e),void 0==is_first_yunwang&&(recentPeople(e),getUnReadMessageNum()),fontCss()},error:function(e){console_func("get recent contact fail",e);var t=Number(e.code);error_func(t),(1001==t||1005==t)&&initAliYunWang(function(){recentContact()})}})}function get_history(e,t,n){void 0==t&&(t=""),void 0==n&&MMDChat.blockUI("#chat_main_div"),sdk.Chat.getHistory({touid:e,nextkey:t,count:max_history_num,success:function(t){return console_func("get history msg success",t),MMDChat.unblockUI("#chat_main_div"),retry_history_num=0,e!=$(".people_li.active").data("uid")?!1:(void 0==n?(next_key_map[e]=t.data.nextKey,appendChatContent(t)):n(t,t.data.nextKey),void fontCss())},error:function(i){console_func("get history msg fail",i),MMDChat.unblockUI("#chat_main_div"),retry_history_num++;var a=Number(i.code);error_func(a),to_chat_more(),1001==a&&(5>retry_history_num?(void 0==n&&$("#loading").html("加载数据出现错误，请重新加载数据"),initAliYunWang(function(){get_history(e,t)})):(retry_history_num=0,void 0==n&&$("#loading").html("加载数据出现错误，请重新加载数据")))}})}function send_message(e,t,n,i){var a=/\n/g;if(t=t.replace(a,new_line),void 0==i){var o=TimeUtil.get13Time((new Date).getTime()),s=TimeUtil.get13Time($(".chat_msg_wrap:last").data("time"));s>=o&&(o=Number(s)+1);var r=TimeUtil.getTimeForChat(o),l=t.split(new_line),d={time_str:r,type:n,msg_array:l,time_ns:o},c=template("chat_msg_template",{list:[d]});appendOneContent(c,t,n,"not"),MMDChat.alertHide(),$("#new_message_area").focus(),i=$(".chat_msg_wrap:last"),i.addClass("loading"),$(".msg_error").unbind("click").click(function(){var e=$(this).parent().parent().parent(),t='<button class="chat-default-btn chat-expand-blue" id="send_msg_again"> <span>重新发送</span> </button>';t+="&nbsp;&nbsp;",t+='<button class="chat-default-btn chat-expand-blue back-grey" id="send_msg_cancel"> <span>取消</span> </button>',MMDChat.alertFunc("该消息发送失败,是否重新发送该条消息?",void 0,t),$("#send_msg_cancel").unbind("click").click(function(){MMDChat.alertHide()}),$("#send_msg_again").unbind("click").click(function(){var t=Number(e.data("type")),n=$(".people_li.active").data("uid"),i="";t==MessageType.text?i=e.find("pre").html().trim().replace(/<br>/,"\n"):t==MessageType.img&&(i=e.find("pre img")[0].src),e.remove(),MMDChat.alertHide(),send_message(n,i,t)})})}sdk.Chat.sendMsg({touid:e,msg:t,msgType:n,success:function(a){console_func("send success",a),console_func("touid:"+e+" message:"+t),retry_send_message_num=0,$("#new_message_area").val(""),i.removeClass("loading"),i.removeClass("error"),n==MessageType.text&&saveLOPWishNumber(t)},error:function(a){console_func("send fail",a),retry_send_message_num++;var o=Number(a.code);error_func(o),1001==o&&(5>retry_send_message_num?initAliYunWang(function(){send_message(e,t,n,i)}):(retry_send_message_num=0,i.removeClass("loading"),i.addClass("error"))),setTimeout(function(){i.hasClass("loading")&&(i.removeClass("loading"),i.addClass("error"))},1e4)}})}function getUnReadMessageNum(){sdk.Base.getUnreadMsgCount({count:100,success:function(e){console_func("get unread msg count success",e),retry_un_read_num=0,UnReadMessageDo(e),void 0==is_first_yunwang?(chat_with_uid_func(),is_first_yunwang=1):MMDChat.unblockUI()},error:function(e){console_func("get unread msg count fail",e),retry_un_read_num++;var t=Number(e.code);error_func(t)}})}function allMessageListenser(){sdk.Event.off("START_RECEIVE_ALL_MSG"),sdk.Base.stopListenAllMsg(),sdk.Event.on("START_RECEIVE_ALL_MSG",function(e){console_func("当前聊天对象的所有内容："),console_func(e);var t=e.code;1005==t?(console_func("allMessageListenser网络波动(网络切换或者断网后又自动连上)"),setTimeout(function(){sdk.Base.startListenAllMsg()},1e3)):1e3==t&&message_listenser_do(e)}),sdk.Base.startListenAllMsg()}function setHaveRead(e,t){error_func(),sdk.Chat.setReadState({touid:e,timestamp:Math.ceil(new Date/1e3),success:function(e){console_func("set read state success",e),retry_have_read_num=0,nowUnReadMsg(),t&&t()},error:function(e){console_func("set read state fail",e),retry_have_read_num++;var t=Number(e.code);error_func(t)}})}function nowUnReadMsg(){var e=0;$.each($(".people_li"),function(t,n){var i=$(n).find(".badge").text();""==i&&(i=0),e+=Number(i)}),e!=all_un_read_sum&&(all_un_read_sum=e,sendUnReadMessageToOut())}function chat_with_uid_func(e){var t=param.to_sys_id,n=param.to_sys_name;return e?(getUsersByuuid(e,chat_with_uid_func_do,function(){MMDChat.unblockUI()}),!1):t&&""!=t&&n&&""!=n?(ImConstants.getUsersData(t,n,chat_with_uid_func_do,function(){MMDChat.unblockUI()}),!1):(0==$(".people_li").length&&noPeopleDo(),void MMDChat.unblockUI())}function chat_with_uid_func_do(e){var t=e.data,n=t.aliUid,i=t.sysName;if(isTheSameSysName(i))return 0==$(".people_li").length&&noPeopleDo(),MMDChat.unblockUI(),!1;var a=!1;if($.each($(".people_li"),function(e,t){var i=$(t).data("uid");return i.toLowerCase()==n.toLowerCase()?(a=!0,$(t).addClass("active"),$(t).trigger("click"),!1):void 0}),!a){if(isMySelf(n))return!1;var o={uid:n,time_ns:(new Date).getTime(),time_str:TimeUtil.getTimeStringForPeople(),sys_id:t.sysId,name:t.userName,nickName:t.userNickName},s=template("people_li_template",{list:[o]});$(".people_ul").prepend(s),people_li_click();var r=$(".people_li:first");$(r).addClass("active"),$(r).trigger("click")}fontCss(),MMDChat.unblockUI()}function getNowChatContentAppend(){var e=$(".people_li.active").data("uid");void 0!=e&&(e=e.toLowerCase(),setHaveRead(e,function(){var t=void 0;$(".chat_msg_wrap").length>0&&(t=function(t,n){var i=t.data.msgs;if(0==i.length)return!1;var a=!1;if($.each(i,function(t,n){var i=n.msg,o=sdk.Base.getNick(n.from).toLowerCase(),s=n.type,r=parseInt(n.time),l=TimeUtil.getTimeForChat(r);if(o!=e)return!0;var d=$(".chat_msg_wrap"),c=[];$.each(d,function(e,t){c.unshift(t)}),$.each(c,function(e,t){if(e>max_history_num)return!1;var n=$(t),o=n.data("time"),d=n.find("pre").html();if(d){var c=/<br>/g;d=d.replace("\n","").replace("\r","").trim().replace(/ /g,"").replace(c,new_line)}if(n.hasClass("chat_l")&&(s==MessageType.text&&i.replace("\n","").replace("\r","").replace(/ /g,"").trim()==d||s==MessageType.img&&isSameImg(i,d)||s==MessageType.voice))return!1;if(TimeUtil.get13Time(o)<TimeUtil.get13Time(r)){console_func("新登录，动态增加的聊天内容"),console_func(n),a=!0,s==MessageType.img&&(i=i.replace("http://","https://"));var u=i.split(new_line),m={msg_array:u,time_ns:r,time_str:l,type:s,you:!0},p=template("chat_msg_template",{list:[m]});console_func(m);var h=!1;return o==$(".chat_msg_wrap:last").data("time")&&n.find("pre").html()==$(".chat_msg_wrap:last").find("pre").html()&&is_footer_bottom()&&(h=!0),n.after(p),s==MessageType.text&&(saveLOPWishNumber(i),fontCss(),h&&to_chat_bottom()),s==MessageType.img&&(img_show_func(),h&&loadHistoryImg(to_chat_bottom,".chat_msg_wrap:last img")),console_func("end 新登录，动态增加的聊天内容"),!1}})}),a){setFirstChatPeople_fuc($(".chat_msg_wrap:last").data("time")),next_key_map[e]=n;for(var o=$(".chat_msg_wrap"),s=o.length,r=0;s-max_history_num>r;r++)$(".chat_msg_wrap:first").remove();fontCss()}}),get_history(e,"",t)}))}function isSameImg(e,t){var n="fileId",i=e.split(n),a=t.split(n);if(i.length<2||a.length<2)return!1;var o=i[1].split("&")[0].replace("=",""),s=a[1].split("&")[0].replace("=","");return o==s?!0:!1}function recentPeople(e){var t=e.data.cnts,n=new Array;$.each(t,function(e,t){var i=sdk.Base.getNick(t.uid);if(isMySelf(i))return!0;var a=parseInt(t.time),o=TimeUtil.getTimeStringForPeople(a);getUsersByuuid(i,function(e){var t=e.data,s=t.sysId,r=t.sysName,l=t.userName,d=t.userNickName;if(l&&!isTheSameSysName(r)){var c={uid:i,time_ns:a,time_str:o,sys_id:s,name:l,nickName:d};n.push(c)}})}),n.sort(function(e,t){return t.time_ns-e.time_ns});var i=template("people_li_template",{list:n});$(".people_ul").html(i),people_li_click()}function appendChatContent(e){$("#loading").html("");var t=$(".people_li.active").data("uid"),n=e.data.msgs,i=!1;0==$(".chat_msg_wrap").length&&(i=!0);var a=new Array,o=[];$.each(n,function(e,n){var s=n.msg,r=sdk.Base.getNick(n.from),l=n.type,d=parseInt(n.time),c=TimeUtil.getTimeForChat(d);l==MessageType.img&&(s=s.replace("http://","https://"));var u=s.split(new_line),m={msg_array:u,time_ns:d,time_str:c,type:l};if(r.toLowerCase()==t.toLowerCase()&&(m.you=!0),a.push(m),l==MessageType.text&&i){var p={time_ns:d,msg:s};o.push(p)}}),historySaveForWish(o),this_un_read_num=0,a.sort(function(e,t){return e.time_ns-t.time_ns});var s=template("chat_msg_template",{list:a}),r=$(".chat_msg_wrap:first");$("#chat_main_div").prepend(s),img_show_func(),(""==s||""==next_key_map[t])&&$("#loading").html("<span>-没有更多数据了-</span>"),i?(setFirstChatPeople_fuc($(".chat_msg_wrap:last").data("time")),loadHistoryImg(to_chat_bottom)):loadHistoryImg(function(){to_chat_more(r)})}function UnReadMessageDo(e){var t=0,n=e.data;$.each(n,function(e,n){var i=sdk.Base.getNick(n.contact),a=n.msgCount,o=n.lastmsgTime,s=!1,r=$(".people_li.active");if(r){var l=r.data("uid");l&&l.toLowerCase()==i.toLowerCase()&&(s=!0)}changePeopleLiFunc(i,a,o,1),s||(t+=Number(a))}),t!=all_un_read_sum&&(all_un_read_sum=t,sendUnReadMessageToOut())}function message_listenser_do(e){var t=all_un_read_sum,n=e.data.msgs,i={};$.each(n,function(e,n){var a=sdk.Base.getNick(n.from).toLowerCase(),o=n.msg,s=n.type,r=n.time,l=TimeUtil.getTimeForChat(r);if(TimeUtil.get13Time(opened_time)>TimeUtil.get13Time(r))return console_func("获得未读消息，时间小于打开时间"),!0;var d=!1,c=$(".people_li.active");if(c){var u=c.data("uid");u&&u.toLowerCase()==a&&(d=!0)}if(d){s==MessageType.img&&(o=o.replace("http://","https://"));var m=o.split(new_line),p={time_str:l,type:s,msg_array:m,time_ns:r,you:!0},h=template("chat_msg_template",{list:[p]});setHaveRead(a,function(){appendOneContent(h,o,s)})}else{var f=i[a];void 0==f&&(f={num:0,time:r,msg_obg:{message:o,type:s}}),f.num+=1,TimeUtil.get13Time(r)>TimeUtil.get13Time(f.time)&&(f.time=r),i[a]=f,t+=1}}),$.each(i,function(e,t){changePeopleLiFunc(e,t.num,t.time,0,t.msg_obg)}),t!=all_un_read_sum&&(all_un_read_sum=t,sendUnReadMessageToOut())}function changePeopleLiFunc(uid,msg_num,time_ns,type,msg_obg){var time_str=TimeUtil.getTimeStringForPeople(time_ns),find_true_uid=!1,has_pli_list=[];if($.each($(".people_li"),function(i,pli_obj){var pe_time_sn=$(pli_obj).data("time"),pe_msg_num=$(pli_obj).find(".badge").text();""==pe_msg_num&&(pe_msg_num="0");var pe_uid=$(pli_obj).data("uid");if(console_func("changePeopleLiFunc: type:"+type+" uid:"+uid+" pe_uid:"+pe_uid),uid.toLowerCase()==pe_uid.toLowerCase()){find_true_uid=!0;var is_active_people=$(pli_obj).hasClass("active");if(0==type&&(msg_num=Number(pe_msg_num)+msg_num),0==Number(msg_num)||is_active_people||$(pli_obj).find(".badge").text(msg_num),TimeUtil.get13Time(time_ns)>TimeUtil.get13Time(pe_time_sn)){$(pli_obj).data("time",time_ns),$(pli_obj).find(".final_name").text(time_str);var new_obj=$(pli_obj).clone();$.each(has_pli_list,function(e,t){return TimeUtil.get13Time(time_ns)>TimeUtil.get13Time($(t).data("time"))?($(t).before(new_obj),$(pli_obj).remove(),!1):void 0})}if(is_first_yunwang&&Number(pe_msg_num)!=Number(msg_num)&&!is_active_people){var pli_name=$(pli_obj).data("name");if(void 0==pli_name||""==pli_name)return!1;if(1==type)NotifyUtil.sendNotify(pli_name,"给你发了"+msg_num+"条未读消息");else{var msg_message=msg_obg.message,msg_type=msg_obg.type,notify_html="给你发了一段语言";msg_type==MessageType.text?notify_html=msg_message.replace(eval("/"+new_line+"/g"),"\n"):msg_type==MessageType.img&&(notify_html="给你发了一张图片"),NotifyUtil.sendNotify(pli_name,notify_html)}}return!1}has_pli_list.push(pli_obj)}),!find_true_uid){if(console_func("changePeopleLiFunc add new people: type:"+type+" uid:"+uid),isMySelf(uid))return!1;var people_list=[];getUsersByuuid(uid,function(result){var userDO=result.data,name=userDO.userName,people_map={uid:uid,time_ns:time_ns,time_str:TimeUtil.getTimeStringForPeople(time_ns),num:msg_num,sys_id:userDO.sysId,name:name,nickName:userDO.userNickName};people_list.push(people_map);var people_html=template("people_li_template",{list:people_list}),people_li_obj=$(".people_li");if(0==people_li_obj.length?$(".people_ul").prepend(people_html):$.each(people_li_obj,function(e,t){return TimeUtil.get13Time(time_ns)>TimeUtil.get13Time($(t).data("time"))?($(t).before(people_html),!1):void 0}),is_first_yunwang){var pli_name=people_map.name;if(void 0==pli_name||""==pli_name)return!1;if(1==type)NotifyUtil.sendNotify(pli_name,"给你发了"+msg_num+"条未读消息");else{var msg_message=msg_obg.message,msg_type=msg_obg.type,notify_html="给你发了一段语言";msg_type==MessageType.text?notify_html=msg_message.replace(eval("/"+new_line+"/g"),"\n"):msg_type==MessageType.img&&(notify_html="给你发了一张图片"),NotifyUtil.sendNotify(pli_name,notify_html)}}})}people_li_click(),fontCss()}function setFirstChatPeople_fuc(e){var t=$(".people_li.active"),n=$(".people_li:first");void 0==e&&(e=(new Date).getTime());var i=TimeUtil.getTimeStringForPeople(e);t.data("time",e),document.querySelector(".people_li.active").dataset.time=e,t.find(".final_name").text(i);var a=t.data("uid"),o=n.data("uid"),s=TimeUtil.get13Time(e),r=!1;if($.each($(".people_li"),function(e,n){if(a==o&&0==e)return!0;var i=$(n).data("time"),l=$(n).find(".final_name").text().trim(),d=TimeUtil.getTimeStringForPeople(i);l!=d&&$(n).find(".final_name").text(d);var c=TimeUtil.get13Time(i);if(s==c)return r=!0,!1;if(s>c){if(r=!0,a==o&&1==e)return!1;var u=t.clone();return $(n).before(u),t.remove(),people_li_click(),!1}}),!r){var l=t.clone();return $(".people_ul").append(l),t.remove(),people_li_click(),!1}}function appendOneContent(e,t,n,i){var a=is_footer_bottom();$("#chat_main_div").append(e),setFirstChatPeople_fuc(),n==MessageType.text&&(fontCss(),a&&to_chat_bottom(),void 0==i&&saveLOPWishNumber(t)),n==MessageType.img&&(a&&loadHistoryImg(to_chat_bottom,".chat_msg_wrap:last img"),img_show_func())}function people_li_click(){$(".people_li").unbind("click").click(function(){if(is_first_wish_click=!0,$.isFunction(beforeChangePeople_func)&&!beforeChangePeople_func())return!1;error_func();var e=$(".people_li.active").data("uid");$(".people_li").removeClass("active"),$(this).addClass("active"),$(".chat_content").hasClass("hidden")&&($(".welcome_content").addClass("hidden"),$(".chat_content").removeClass("hidden")),e!=$(this).data("uid")&&$(".expand_btn_close").trigger("click"),chat_content_do()})}function chat_content_do(){var e=$(".people_li.active"),t=e.find(".badge").text();this_un_read_num=0,""!=t&&(this_un_read_num=Number(t),all_un_read_sum-=Number(t),sendUnReadMessageToOut()),e.find(".badge").text(""),document.title="您正在和【"+e.data("name")+"】对话中",$("#new_message_area").val(""),$("#chat_main_div").html(""),$("#loading").html(""),setHaveRead(e.data("uid")),iframe_func(),chat_html_func(),util_func(),send_message_func()}function iframe_func(){var e=$("#top_url").val(),t=$(".people_li.active"),n=t.data("uid"),i=t.data("sys_id"),a=param.to_sys_id,o=param.bottom_url_btn_name,s=param.bottom_url;""!=e.trim()&&a&&i==a&&(iframe_top_map[n]=e,$("#top_url").val(""));var r=iframe_top_map[n];if(r&&""!=r.trim()){var l=template("expand_top_template",{top_url:r});$("#chat_main_div").append(l),$("#expand_top").removeClass("hidden"),$("#expand_top_close").unbind("click").click(function(){expand_top_click()})}if(void 0!=o&&""!=o.trim()||void 0!=s&&""!=s.trim()){if($(".chat_content").removeClass("no-expand"),o&&""!=o.trim()&&$(".expand_bottom_name").text(o.trim()),s&&""!=s.trim()){var d=param.sys_id;s=s.replace("chat_sys_id",d).replace("chat_to_sys_id",i),$("#expand_bottom_iframe").attr("src",s)}}else $(".chat_content").addClass("no-expand")}function chat_html_func(){var e=$(".people_li.active"),t=e.data("name"),n=e.data("uid");$("#chat_content_header").text(t),get_history(n)}function util_func(){$("#cut_util").unbind("click").click(function(){var e="亲，截图功能暂未开放，请使用截图工具进行复制黏贴，谢谢",t='<div class="cut_show">';t+='<div class="title"><i class="fa  fa-quote-left"></i>截图流程<i class="fa  fa-quote-right"></i></div>',t+='<div><span>使用QQ等截图工具截取需要区域(可快捷键)</span><i class="fa fa-arrow-down"></i></div>',t+='<div><img  src="'+ConstantsMap.headerUrl+'/img/cut/choose_cut.jpg"></div>',t+='<div><span>确定截图页面</span><i class="fa fa-arrow-down"></i></div>',t+='<div><img src="'+ConstantsMap.headerUrl+'/img/cut/cut.jpg"></div>',t+='<div><span>鼠标点击锁定车信聊天页面</span><i class="fa fa-arrow-down"></i></div>',t+='<div><img src="'+ConstantsMap.headerUrl+'/img/cut/focus_chat.jpg"></div>',t+='<div><span>Ctrl+V(window)/Command+V(Mac)黏贴图片</span><i class="fa fa-check"></i></div>',t+="</div>",MMDChat.alertFunc(e,t)}),$("#pic_util").unbind("change").change(function(){putImgFile()})}function putImgFile(){var e=document.getElementById("pic_util").files[0];$("#pic_util").val(""),solveImgFile(e)}function solveImgFile(e){var t=e.name,n=t.substring(t.lastIndexOf("."),t.length).toUpperCase();if(".PNG"!=n&&".JPG"!=n&&".JPEG"!=n&&".BMP"!=n)return MMDChat.alertFunc("当前上传的文件不是支持的图片类型(png/jpg/jpeg/bmp)，请选择图片重新上传"),!1;var i=e.size;if(i>3145728)return MMDChat.alertFunc("图片文件大于3MB，无法发送，请压缩后重新发送"),!1;var a=new FileReader;a.readAsDataURL(e),a.onload=function(e){var t=e.target.result;i>307200?doPic("1",t):doPic(void 0,t)}}function doPic(e,t){var n=t.split(",")[1],i=template("loading_template",{});MMDChat.alertFunc("发送图片",i,'<button class="chat-default-btn">发送</button>'),e&&(n=reduceImg(t)),img_data=n,send_img()}function send_img(){sdk.Plugin.Image.upload({base64Img:img_data,ext:"jpeg",timeout:2e4,success:function(e){console_func("upload base64ed success",e.data.url),img_fail_index=0;var t=e.data.url.replace("http://","https://");MMDChat.alertHide();var n='<div class="img"><img src="'+t+'"></div>',i='<button class="chat-default-btn chat-expand-blue" id="send_pic_btn" >发送</button>';MMDChat.alertFunc("发送图片",n,i),$("#send_pic_btn").unbind("click").click(function(){var e=$(".people_li.active").data("uid");send_message(e,t,MessageType.img)})},error:function(e){console_func("upload base64d fail",e),10>img_fail_index?setTimeout(function(){send_img(),img_fail_index++},1e3):(img_fail_index=0,MMDChat.alertHide(),MMDChat.alertFunc("图片加载失败，请重试"))}})}function reduceImg(e){var t=document.createElement("canvas"),n=new Image,i=t.getContext("2d");n.src=e;var a=(1024e3/(n.naturalWidth*n.naturalHeight)).toString();t.width=n.naturalWidth*a,t.height=n.naturalHeight*a,i.drawImage(n,0,0,t.width,t.height);var o=t.toDataURL("image/jpeg"),s=o.split(",")[1];return s}function loadHistoryImg(e,t){var n=[];void 0==t&&(t=".chat-msg-item img"),$(t).each(function(){var e=$.Deferred();$(this).bind("load",function(){e.resolve()}),this.complete&&e.resolve(),n.push(e)}),$.when.apply(null,n).done(function(){e()})}function img_show_func(){$(".chat-msg-item img").unbind("click").click(function(){MMDChat.alertImg($(this)[0].src)})}function send_message_func(){var e=$(".people_li.active").data("uid"),t=$("#new_message_area"),n=$("#send_btn");t.focus(),t.unbind("keypress").bind("keypress",function(e){return 13!=Number(e.keyCode)&&10!=Number(e.keyCode)||e.ctrlKey?13!=Number(e.keyCode)&&10!=Number(e.keyCode)||!e.ctrlKey?void 0:(t.val(t.val()+"\n"),!1):(n.trigger("click"),!1)}),n.unbind("click").click(function(){var n=t.val().trim();return""==n?(console_func("not send message"),t.val(""),!1):n.length>500?(MMDChat.alertFunc("抱歉，单次发送字数不能超过500字，请分批发送"),!1):(t.val(""),void send_message(e,n,MessageType.text))})}function sendUnReadMessageToOut(){ConstantsMap.storage.setItem(pageKey+StorageKey.unReadMsgSum,all_un_read_sum)}function StoryListener(){var e=function(e){console_func("storage changed:"),console_func(e);var t=e.key,n=e.newValue;if(void 0==t)return!1;if(void 0==pageKey)return!1;if(-1==t.indexOf(pageKey))return!1;if(n&&"undefined"!=n){if(t==pageKey+StorageKey.isFocus)return alert("现在，您可以和我欢度聊天时光了~~"),ConstantsMap.storage.removeItem(pageKey+StorageKey.isFocus),!1;if(t==pageKey+StorageKey.topUrl)return $("#top_url").val(n),ConstantsMap.storage.removeItem(pageKey+StorageKey.topUrl),!1;if(t==pageKey+StorageKey.chatWithUid){var i=n.split(",");return param.to_sys_id=i[1],chat_with_uid_func(i[0]),ConstantsMap.storage.removeItem(pageKey+StorageKey.chatWithUid),!1}if(t==pageKey+StorageKey.isClosed)return windowClose(),!1}};window.removeEventListener("storage",e),window.addEventListener("storage",e)}function expand_top_click(){$("#expand_top").addClass("hidden"),param.top_url=void 0,iframe_top_map[$(".people_li.active").data("uid")]=void 0,$("#top_url").val("")}function check_is_not_wish(e){if(is_first_wish_click){var t=$(".people_li.active").data("uid");setTimeout(function(){var n=$(".people_li.active").data("uid");if(n!=t)return console_func("send wish list fail,the people changed"),!1;is_first_wish_click=!1;var i=expand_bottom_iframe.window.MonkWishListFunc;$.isFunction(i)&&e()},2e3)}else{var n=expand_bottom_iframe.window.MonkWishListFunc;$.isFunction(n)&&e()}}function historySaveForWish(e){check_is_not_wish(function(){if(void 0==e||0==e.length)return!1;var t=[];$.each(e,function(e,n){var i=n.time_ns,a=n.msg;if(TimeUtil.isToday(i)){var o=getWishListFromMsg(a);t=t.concat(o)}}),t.sort(),t=$.unique(t),send_wish_final(t)})}function saveLOPWishNumber(e){check_is_not_wish(function(){var t=getWishListFromMsg(e);send_wish_final(t)})}function getWishListFromMsg(e){var t=e.length;if(15>t)return[];var n=/X[\d]{14}/g,i=e.match(n);return void 0==i||0==i.length?[]:i}function send_wish_final(e){if(void 0==send_wish_final||0==send_wish_final.length)return!1;var t=$(".people_li.active").data("sys_id"),n=(new Date).toLocaleDateString()+"-"+t,i=[],a=window.sessionStorage.getItem(n);a&&""!=a&&(i=JSON.parse(a)),void 0==i&&(i=[]);var o=[],s=!1;$.each(e,function(e,t){return i.indexOf(t)>-1?!0:void(-1==o.indexOf(t)&&(o.push(t),i.push(t),s=!0))}),s&&(console_func("推送需求单数据："),console_func(o),send_wish_to_iframe(n,t,o,i))}function send_wish_to_iframe(e,t,n,i){var a=expand_bottom_iframe.window.MonkWishListFunc;console_func("推送需求单的func1："),console_func(a),$.isFunction(a)&&(console_func("into func"),a({to_sys_id:t,wish_list:n}),window.sessionStorage.setItem(e,JSON.stringify(i)),console_func("out func"))}function noPeopleDo(){var e=param.guide_content,t=param.guide_url;if(void 0==t||void 0==e)return!1;var n=e,i='<button class="chat-default-btn chat-expand-blue" id="no_people_do_btn"> <span>立刻前往</span> </button>';return i+="&nbsp;&nbsp;",i+='<button class="chat-default-btn chat-expand-blue back-grey" id="no_people_cancle"> <span>取消</span> </button>',MMDChat.alertFunc(n,void 0,i),$("#no_people_cancle").unbind("click").click(function(){MMDChat.alertHide()}),$("#no_people_do_btn").unbind("click").click(function(){MMDChat.alertHide();var e=window.opener;if(void 0==e){var n='<a id="chat_monk_parent_url_a" href="'+t+'" target="_blank"></a>';$("body").append(n),windowClose(),document.getElementById("chat_monk_parent_url_a").click()}else window.opener.location.href=t,windowClose()}),!1}function console_func(e,t){is_the_test&&(t?console.log(e,t):console.log(e))}function isTheSameSysName(e){return!1}function isMySelf(e){return e.toLowerCase()==aliUid.toLowerCase()?(ConstantsMap.storage.removeItem("__WSDK__"),!0):!1}function getUsersByuuid(e,t,n){$.ajax({url:ConstantsMap.headerUrl+"/monk/chat/getUserNameByAliUid",data:{uid:e},async:!1,success:function(e){e.success?t(e):n&&n(e)}})}function backgroundReady(){$.backstretch([ConstantsMap.headerUrl+"/img/bg/1.jpg",ConstantsMap.headerUrl+"/img/bg/2.jpg",ConstantsMap.headerUrl+"/img/bg/3.jpg",ConstantsMap.headerUrl+"/img/bg/4.jpg"],{fade:1e3,duration:2e4})}function to_chat_bottom(){var e=$("#chat_main_div"),t=$(".chat_msg_wrap:last");void 0!=t.offset()&&$(".chat_main").animate({scrollTop:t.offset().top-e.offset().top+e.scrollTop()+300},1)}function is_footer_bottom(){$(".chat_msg_wrap:last").offset(),$(".chat_main").height()-4;return!0}function to_chat_more(e){var t=1;e&&(t=$(e).offset().top-300),$(".chat_main").animate({scrollTop:t},1)}function alertForChild(e,t,n){MMDChat.alertFunc(e,t,n)}function alertHideForChild(){MMDChat.alertHide()}function alertImgForChlid(e){MMDChat.alertImg(e)}function alertImgHideForChlid(e){MMDChat.alertImgHide()}!function(){function e(e){return e.replace(b,"").replace(y,",").replace($,"").replace(k,"").replace(w,"").split(C)}function t(e){return"'"+e.replace(/('|\\)/g,"\\$1").replace(/\r/g,"\\r").replace(/\n/g,"\\n")+"'"}function n(n,i){function a(e){return m+=e.split(/\n/).length-1,c&&(e=e.replace(/\s+/g," ").replace(/<!--[\w\W]*?-->/g,"")),e&&(e=v[1]+t(e)+v[2]+"\n"),e}function o(t){var n=m;if(d?t=d(t,i):s&&(t=t.replace(/\n/g,function(){return m++,"$line="+m+";"})),0===t.indexOf("=")){var a=u&&!/^=[=#]/.test(t);if(t=t.replace(/^=[=#]?|[\s;]*$/g,""),a){var o=t.replace(/\s*\([^\)]+\)/,"");p[o]||/^(include|print)$/.test(o)||(t="$escape("+t+")")}else t="$string("+t+")";t=v[1]+t+v[2]}return s&&(t="$line="+n+";"+t),_(e(t),function(e){if(e&&!f[e]){var t;t="print"===e?y:"include"===e?$:p[e]?"$utils."+e:h[e]?"$helpers."+e:"$data."+e,k+=e+"="+t+",",f[e]=!0}}),t+"\n"}var s=i.debug,r=i.openTag,l=i.closeTag,d=i.parser,c=i.compress,u=i.escape,m=1,f={$data:1,$filename:1,$utils:1,$helpers:1,$out:1,$line:1},g="".trim,v=g?["$out='';","$out+=",";","$out"]:["$out=[];","$out.push(",");","$out.join('')"],b=g?"$out+=text;return $out;":"$out.push(text);",y="function(){var text=''.concat.apply('',arguments);"+b+"}",$="function(filename,data){data=data||$data;var text=$utils.$include(filename,data,$filename);"+b+"}",k="'use strict';var $utils=this,$helpers=$utils.$helpers,"+(s?"$line=0,":""),w=v[0],C="return new String("+v[3]+");";_(n.split(r),function(e){e=e.split(l);var t=e[0],n=e[1];1===e.length?w+=a(t):(w+=o(t),n&&(w+=a(n)))});var x=k+w+C;s&&(x="try{"+x+"}catch(e){throw {filename:$filename,name:'Render Error',message:e.message,line:$line,source:"+t(n)+".split(/\\n/)[$line-1].replace(/^\\s+/,'')};}");try{var M=new Function("$data","$filename",x);return M.prototype=p,M}catch(U){throw U.temp="function anonymous($data,$filename) {"+x+"}",U}}var i=function(e,t){return"string"==typeof t?g(t,{filename:e}):s(e,t)};i.version="3.0.0",i.config=function(e,t){a[e]=t};var a=i.defaults={openTag:"<%",closeTag:"%>",escape:!0,cache:!0,compress:!1,parser:null},o=i.cache={};i.render=function(e,t){return g(e,t)};var s=i.renderFile=function(e,t){var n=i.get(e)||f({filename:e,name:"Render Error",message:"Template not found"
});return t?n(t):n};i.get=function(e){var t;if(o[e])t=o[e];else if("object"==typeof document){var n=document.getElementById(e);if(n){var i=(n.value||n.innerHTML).replace(/^\s*|\s*$/g,"");t=g(i,{filename:e})}}return t};var r=function(e,t){return"string"!=typeof e&&(t=typeof e,"number"===t?e+="":e="function"===t?r(e.call(e)):""),e},l={"<":"&#60;",">":"&#62;",'"':"&#34;","'":"&#39;","&":"&#38;"},d=function(e){return l[e]},c=function(e){return r(e).replace(/&(?![\w#]+;)|[<>"']/g,d)},u=Array.isArray||function(e){return"[object Array]"==={}.toString.call(e)},m=function(e,t){var n,i;if(u(e))for(n=0,i=e.length;i>n;n++)t.call(e,e[n],n,e);else for(n in e)t.call(e,e[n],n)},p=i.utils={$helpers:{},$include:s,$string:r,$escape:c,$each:m};i.helper=function(e,t){h[e]=t};var h=i.helpers=p.$helpers;i.onerror=function(e){var t="Template Error\n\n";for(var n in e)t+="<"+n+">\n"+e[n]+"\n\n";"object"==typeof console&&console.error(t)};var f=function(e){return i.onerror(e),function(){return"{Template Error}"}},g=i.compile=function(e,t){function i(n){try{return new l(n,r)+""}catch(i){return t.debug?f(i)():(t.debug=!0,g(e,t)(n))}}t=t||{};for(var s in a)void 0===t[s]&&(t[s]=a[s]);var r=t.filename;try{var l=n(e,t)}catch(d){return d.filename=r||"anonymous",d.name="Syntax Error",f(d)}return i.prototype=l.prototype,i.toString=function(){return l.toString()},r&&t.cache&&(o[r]=i),i},_=p.$each,v="break,case,catch,continue,debugger,default,delete,do,else,false,finally,for,function,if,in,instanceof,new,null,return,switch,this,throw,true,try,typeof,var,void,while,with,abstract,boolean,byte,char,class,const,double,enum,export,extends,final,float,goto,implements,import,int,interface,long,native,package,private,protected,public,short,static,super,synchronized,throws,transient,volatile,arguments,let,yield,undefined",b=/\/\*[\w\W]*?\*\/|\/\/[^\n]*\n|\/\/[^\n]*$|"(?:[^"\\]|\\[\w\W])*"|'(?:[^'\\]|\\[\w\W])*'|\s*\.\s*[$\w\.]+/g,y=/[^\w$]+/g,$=new RegExp(["\\b"+v.replace(/,/g,"\\b|\\b")+"\\b"].join("|"),"g"),k=/^\d[^,]*|,\d[^,]*/g,w=/^,+|,+$/g,C=/^$|,+/;a.openTag="{{",a.closeTag="}}";var x=function(e,t){var n=t.split(":"),i=n.shift(),a=n.join(":")||"";return a&&(a=", "+a),"$helpers."+i+"("+e+a+")"};a.parser=function(e){e=e.replace(/^\s/,"");var t=e.split(" "),n=t.shift(),a=t.join(" ");switch(n){case"if":e="if("+a+"){";break;case"else":t="if"===t.shift()?" if("+t.join(" ")+")":"",e="}else"+t+"{";break;case"/if":e="}";break;case"each":var o=t[0]||"$data",s=t[1]||"as",r=t[2]||"$value",l=t[3]||"$index",d=r+","+l;"as"!==s&&(o="[]"),e="$each("+o+",function("+d+"){";break;case"/each":e="});";break;case"echo":e="print("+a+");";break;case"print":case"include":e=n+"("+t.join(",")+");";break;default:if(/^\s*\|\s*[\w\$]/.test(a)){var c=!0;0===e.indexOf("#")&&(e=e.substr(1),c=!1);for(var u=0,m=e.split("|"),p=m.length,h=m[u++];p>u;u++)h=x(h,m[u]);e=(c?"=":"=#")+h}else e=i.helpers[n]?"=#"+n+"("+t.join(",")+");":"="+e}return e},"function"==typeof define?define(function(){return i}):"undefined"!=typeof exports?module.exports=i:this.template=i}(),!function(e){"use strict";function t(e){return function(t){return t&&this===t.target?e.apply(this,arguments):void 0}}var n=function(e,t){this.init(e,t)};n.prototype={constructor:n,init:function(t,n){if(this.$element=e(t),this.options=e.extend({},e.fn.modalmanager.defaults,this.$element.data(),"object"==typeof n&&n),this.stack=[],this.backdropCount=0,this.options.resize){var i,a=this;e(window).on("resize.modal",function(){i&&clearTimeout(i),i=setTimeout(function(){for(var e=0;e<a.stack.length;e++)a.stack[e].isShown&&a.stack[e].layout()},10)})}},createModal:function(t,n){e(t).modal(e.extend({manager:this},n))},appendModal:function(n){this.stack.push(n);var i=this;n.$element.on("show.modalmanager",t(function(t){var a=function(){n.isShown=!0;var t=e.support.transition&&n.$element.hasClass("fade");i.$element.toggleClass("modal-open",i.hasOpenModal()).toggleClass("page-overflow",e(window).height()<i.$element.height()),n.$parent=n.$element.parent(),n.$container=i.createContainer(n),n.$element.appendTo(n.$container),i.backdrop(n,function(){n.$element.show(),t&&n.$element[0].offsetWidth,n.layout(),n.$element.addClass("in").attr("aria-hidden",!1);var a=function(){i.setFocus(),n.$element.trigger("shown")};t?n.$element.one(e.support.transition.end,a):a()})};n.options.replace?i.replace(a):a()})),n.$element.on("hidden.modalmanager",t(function(t){if(i.backdrop(n),n.$element.parent().length)if(n.$backdrop){var a=e.support.transition&&n.$element.hasClass("fade");a&&n.$element[0].offsetWidth,e.support.transition&&n.$element.hasClass("fade")?n.$backdrop.one(e.support.transition.end,function(){n.destroy()}):n.destroy()}else n.destroy();else i.destroyModal(n)})),n.$element.on("destroyed.modalmanager",t(function(e){i.destroyModal(n)}))},getOpenModals:function(){for(var e=[],t=0;t<this.stack.length;t++)this.stack[t].isShown&&e.push(this.stack[t]);return e},hasOpenModal:function(){return this.getOpenModals().length>0},setFocus:function(){for(var e,t=0;t<this.stack.length;t++)this.stack[t].isShown&&(e=this.stack[t]);e&&e.focus()},destroyModal:function(e){e.$element.off(".modalmanager"),e.$backdrop&&this.removeBackdrop(e),this.stack.splice(this.getIndexOfModal(e),1);var t=this.hasOpenModal();this.$element.toggleClass("modal-open",t),t||this.$element.removeClass("page-overflow"),this.removeContainer(e),this.setFocus()},getModalAt:function(e){return this.stack[e]},getIndexOfModal:function(e){for(var t=0;t<this.stack.length;t++)if(e===this.stack[t])return t},replace:function(n){for(var i,a=0;a<this.stack.length;a++)this.stack[a].isShown&&(i=this.stack[a]);i?(this.$backdropHandle=i.$backdrop,i.$backdrop=null,n&&i.$element.one("hidden",t(e.proxy(n,this))),i.hide()):n&&n()},removeBackdrop:function(e){e.$backdrop.remove(),e.$backdrop=null},createBackdrop:function(t,n){var i;return this.$backdropHandle?(i=this.$backdropHandle,i.off(".modalmanager"),this.$backdropHandle=null,this.isLoading&&this.removeSpinner()):i=e(n).addClass(t).appendTo(this.$element),i},removeContainer:function(e){e.$container.remove(),e.$container=null},createContainer:function(n){var a;return a=e('<div class="modal-scrollable">').css("z-index",i("modal",this.getOpenModals().length)).appendTo(this.$element),n&&"static"!=n.options.backdrop?a.on("click.modal",t(function(e){n.hide()})):n&&a.on("click.modal",t(function(e){n.attention()})),a},backdrop:function(t,n){var a=t.$element.hasClass("fade")?"fade":"",o=t.options.backdrop&&this.backdropCount<this.options.backdropLimit;if(t.isShown&&o){var s=e.support.transition&&a&&!this.$backdropHandle;t.$backdrop=this.createBackdrop(a,t.options.backdropTemplate),t.$backdrop.css("z-index",i("backdrop",this.getOpenModals().length)),s&&t.$backdrop[0].offsetWidth,t.$backdrop.addClass("in"),this.backdropCount+=1,s?t.$backdrop.one(e.support.transition.end,n):n()}else if(!t.isShown&&t.$backdrop){t.$backdrop.removeClass("in"),this.backdropCount-=1;var r=this;e.support.transition&&t.$element.hasClass("fade")?t.$backdrop.one(e.support.transition.end,function(){r.removeBackdrop(t)}):r.removeBackdrop(t)}else n&&n()},removeSpinner:function(){this.$spinner&&this.$spinner.remove(),this.$spinner=null,this.isLoading=!1},removeLoading:function(){this.$backdropHandle&&this.$backdropHandle.remove(),this.$backdropHandle=null,this.removeSpinner()},loading:function(t){if(t=t||function(){},this.$element.toggleClass("modal-open",!this.isLoading||this.hasOpenModal()).toggleClass("page-overflow",e(window).height()<this.$element.height()),this.isLoading)if(this.isLoading&&this.$backdropHandle){this.$backdropHandle.removeClass("in");var n=this;e.support.transition?this.$backdropHandle.one(e.support.transition.end,function(){n.removeLoading()}):n.removeLoading()}else t&&t(this.isLoading);else{this.$backdropHandle=this.createBackdrop("fade",this.options.backdropTemplate),this.$backdropHandle[0].offsetWidth;var a=this.getOpenModals();this.$backdropHandle.css("z-index",i("backdrop",a.length+1)).addClass("in");var o=e(this.options.spinner).css("z-index",i("modal",a.length+1)).appendTo(this.$element).addClass("in");this.$spinner=e(this.createContainer()).append(o).on("click.modalmanager",e.proxy(this.loading,this)),this.isLoading=!0,e.support.transition?this.$backdropHandle.one(e.support.transition.end,t):t()}}};var i=function(){var t,n={};return function(i,a){if("undefined"==typeof t){var o=e('<div class="modal hide" />').appendTo("body"),s=e('<div class="modal-backdrop hide" />').appendTo("body");n.modal=+o.css("z-index"),n.backdrop=+s.css("z-index"),t=n.modal-n.backdrop,o.remove(),s.remove(),s=o=null}return n[i]+t*a}}();e.fn.modalmanager=function(t,i){return this.each(function(){var a=e(this),o=a.data("modalmanager");o||a.data("modalmanager",o=new n(this,t)),"string"==typeof t&&o[t].apply(o,[].concat(i))})},e.fn.modalmanager.defaults={backdropLimit:999,resize:!0,spinner:'<div class="loading-spinner fade" style="width: 200px; margin-left: -100px;"><div class="progress progress-striped active"><div class="bar" style="width: 100%;"></div></div></div>',backdropTemplate:'<div class="modal-backdrop" />'},e.fn.modalmanager.Constructor=n,e(function(){e(document).off("show.bs.modal").off("hidden.bs.modal")})}(jQuery),!function(e){"use strict";var t=function(e,t){this.init(e,t)};t.prototype={constructor:t,init:function(t,n){var i=this;this.options=n,this.$element=e(t).delegate('[data-dismiss="modal"]',"click.dismiss.modal",e.proxy(this.hide,this)),this.options.remote&&this.$element.find(".modal-body").load(this.options.remote,function(){var t=e.Event("loaded");i.$element.trigger(t)});var a="function"==typeof this.options.manager?this.options.manager.call(this):this.options.manager;a=a.appendModal?a:e(a).modalmanager().data("modalmanager"),a.appendModal(this)},toggle:function(){return this[this.isShown?"hide":"show"]()},show:function(){var t=e.Event("show");this.isShown||(this.$element.trigger(t),t.isDefaultPrevented()||(this.escape(),this.tab(),this.options.loading&&this.loading()))},hide:function(t){t&&t.preventDefault(),t=e.Event("hide"),this.$element.trigger(t),this.isShown&&!t.isDefaultPrevented()&&(this.isShown=!1,this.escape(),this.tab(),this.isLoading&&this.loading(),e(document).off("focusin.modal"),this.$element.removeClass("in").removeClass("animated").removeClass(this.options.attentionAnimation).removeClass("modal-overflow").attr("aria-hidden",!0),e.support.transition&&this.$element.hasClass("fade")?this.hideWithTransition():this.hideModal())},layout:function(){var t=this.options.height?"height":"max-height",n=this.options.height||this.options.maxHeight;if(this.options.width){this.$element.css("width",this.options.width);var i=this;this.$element.css("margin-left",function(){return/%/gi.test(i.options.width)?-(parseInt(i.options.width)/2)+"%":-(e(this).width()/2)+"px"})}else this.$element.css("width",""),this.$element.css("margin-left","");this.$element.find(".modal-body").css("overflow","").css(t,""),n&&this.$element.find(".modal-body").css("overflow","auto").css(t,n);var a=e(window).height()-10<this.$element.height();a||this.options.modalOverflow?this.$element.css("margin-top",0).addClass("modal-overflow"):this.$element.css("margin-top",0-this.$element.height()/2).removeClass("modal-overflow")},tab:function(){var t=this;this.isShown&&this.options.consumeTab?this.$element.on("keydown.tabindex.modal","[data-tabindex]",function(n){if(n.keyCode&&9==n.keyCode){var i=[],a=Number(e(this).data("tabindex"));t.$element.find("[data-tabindex]:enabled:visible:not([readonly])").each(function(t){i.push(Number(e(this).data("tabindex")))}),i.sort(function(e,t){return e-t});var o=e.inArray(a,i);n.shiftKey?0==o?t.$element.find("[data-tabindex="+i[i.length-1]+"]").focus():t.$element.find("[data-tabindex="+i[o-1]+"]").focus():o<i.length-1?t.$element.find("[data-tabindex="+i[o+1]+"]").focus():t.$element.find("[data-tabindex="+i[0]+"]").focus(),n.preventDefault()}}):this.isShown||this.$element.off("keydown.tabindex.modal")},escape:function(){var e=this;this.isShown&&this.options.keyboard?(this.$element.attr("tabindex")||this.$element.attr("tabindex",-1),this.$element.on("keyup.dismiss.modal",function(t){27==t.which&&e.hide()})):this.isShown||this.$element.off("keyup.dismiss.modal")},hideWithTransition:function(){var t=this,n=setTimeout(function(){t.$element.off(e.support.transition.end),t.hideModal()},500);this.$element.one(e.support.transition.end,function(){clearTimeout(n),t.hideModal()})},hideModal:function(){var e=this.options.height?"height":"max-height",t=this.options.height||this.options.maxHeight;t&&this.$element.find(".modal-body").css("overflow","").css(e,""),this.$element.hide().trigger("hidden")},removeLoading:function(){this.$loading.remove(),this.$loading=null,this.isLoading=!1},loading:function(t){t=t||function(){};var n=this.$element.hasClass("fade")?"fade":"";if(this.isLoading)if(this.isLoading&&this.$loading){this.$loading.removeClass("in");var i=this;e.support.transition&&this.$element.hasClass("fade")?this.$loading.one(e.support.transition.end,function(){i.removeLoading()}):i.removeLoading()}else t&&t(this.isLoading);else{var a=e.support.transition&&n;this.$loading=e('<div class="loading-mask '+n+'">').append(this.options.spinner).appendTo(this.$element),a&&this.$loading[0].offsetWidth,this.$loading.addClass("in"),this.isLoading=!0,a?this.$loading.one(e.support.transition.end,t):t()}},focus:function(){var e=this.$element.find(this.options.focusOn);e=e.length?e:this.$element,e.focus()},attention:function(){if(this.options.attentionAnimation){this.$element.removeClass("animated").removeClass(this.options.attentionAnimation);var e=this;setTimeout(function(){e.$element.addClass("animated").addClass(e.options.attentionAnimation)},0)}this.focus()},destroy:function(){var t=e.Event("destroy");this.$element.trigger(t),t.isDefaultPrevented()||(this.$element.off(".modal").removeData("modal").removeClass("in").attr("aria-hidden",!0),this.$parent!==this.$element.parent()?this.$element.appendTo(this.$parent):this.$parent.length||(this.$element.remove(),this.$element=null),this.$element.trigger("destroyed"))}},e.fn.modal=function(n,i){return this.each(function(){var a=e(this),o=a.data("modal"),s=e.extend({},e.fn.modal.defaults,a.data(),"object"==typeof n&&n);o||a.data("modal",o=new t(this,s)),"string"==typeof n?o[n].apply(o,[].concat(i)):s.show&&o.show()})},e.fn.modal.defaults={keyboard:!0,backdrop:!0,loading:!1,show:!0,width:null,height:null,maxHeight:null,modalOverflow:!1,consumeTab:!0,focusOn:null,replace:!1,resize:!1,attentionAnimation:"shake",manager:"body",spinner:'<div class="loading-spinner" style="width: 200px; margin-left: -100px;"><div class="progress progress-striped active"><div class="bar" style="width: 100%;"></div></div></div>',backdropTemplate:'<div class="modal-backdrop" />'},e.fn.modal.Constructor=t,e(function(){e(document).off("click.modal").on("click.modal.data-api",'[data-toggle="modal"]',function(t){var n=e(this),i=n.attr("href"),a=e(n.attr("data-target")||i&&i.replace(/.*(?=#[^\s]+$)/,"")),o=a.data("modal")?"toggle":e.extend({remote:!/#/.test(i)&&i},a.data(),n.data());t.preventDefault(),a.modal(o).one("hide",function(){n.focus()})})})}(window.jQuery),function(e,t,n){"use strict";e.fn.backstretch=function(i,o){return(i===n||0===i.length)&&e.error("No images were supplied for Backstretch"),0===e(t).scrollTop()&&t.scrollTo(0,0),this.each(function(){var t=e(this),n=t.data("backstretch");n&&(o=e.extend(n.options,o),n.destroy(!0)),n=new a(this,i,o),t.data("backstretch",n)})},e.backstretch=function(t,n){return e("body").backstretch(t,n).data("backstretch")},e.expr[":"].backstretch=function(t){return e(t).data("backstretch")!==n},e.fn.backstretch.defaults={centeredX:!0,centeredY:!0,duration:5e3,fade:0};var i={wrap:{left:0,top:0,overflow:"hidden",margin:0,padding:0,height:"100%",width:"100%",zIndex:-999999},img:{position:"absolute",display:"none",margin:0,padding:0,border:"none",width:"auto",height:"auto",maxWidth:"none",zIndex:-999999}},a=function(n,a,s){if(this.options=e.extend({},e.fn.backstretch.defaults,s||{}),this.images=e.isArray(a)?a:[a],e.each(this.images,function(){e("<img />")[0].src=this}),this.isBody=n===document.body,this.$container=e(n),this.$wrap=e('<div class="backstretch"></div>').css(i.wrap).appendTo(this.$container),this.$root=this.isBody?e(o?t:document):this.$container,!this.isBody){var r=this.$container.css("position"),l=this.$container.css("zIndex");this.$container.css({position:"static"===r?"relative":r,zIndex:"auto"===l?0:l,background:"none"}),this.$wrap.css({zIndex:-999998})}this.$wrap.css({position:this.isBody&&o?"fixed":"absolute"}),this.index=0,this.show(this.index),e(t).on("resize.backstretch",e.proxy(this.resize,this)).on("orientationchange.backstretch",e.proxy(function(){this.isBody&&0===t.pageYOffset&&(t.scrollTo(0,1),this.resize())},this))};a.prototype={resize:function(){try{var e,n={left:0,top:0},i=this.isBody?this.$root.width():this.$root.innerWidth(),a=i,o=this.isBody?t.innerHeight?t.innerHeight:this.$root.height():this.$root.innerHeight(),s=a/this.$img.data("ratio");s>=o?(e=(s-o)/2,this.options.centeredY&&(n.top="-"+e+"px")):(s=o,a=s*this.$img.data("ratio"),e=(a-i)/2,this.options.centeredX&&(n.left="-"+e+"px")),this.$wrap.css({width:i,height:o}).find("img:not(.deleteable)").css({width:a,height:s}).css(n)}catch(r){}return this},show:function(t){if(!(Math.abs(t)>this.images.length-1)){this.index=t;var n=this,a=n.$wrap.find("img").addClass("deleteable"),o=e.Event("backstretch.show",{relatedTarget:n.$container[0]});return clearInterval(n.interval),n.$img=e("<img />").css(i.img).bind("load",function(t){var i=this.width||e(t.target).width(),s=this.height||e(t.target).height();e(this).data("ratio",i/s),e(this).fadeIn(n.options.speed||n.options.fade,function(){a.remove(),n.paused||n.cycle(),n.$container.trigger(o,n)}),n.resize()}).appendTo(n.$wrap),n.$img.attr("src",n.images[t]),n}},next:function(){return this.show(this.index<this.images.length-1?this.index+1:0)},prev:function(){return this.show(0===this.index?this.images.length-1:this.index-1)},pause:function(){return this.paused=!0,this},resume:function(){return this.paused=!1,this.next(),this},cycle:function(){return this.images.length>1&&(clearInterval(this.interval),this.interval=setInterval(e.proxy(function(){this.paused||this.next()},this),this.options.duration)),this},destroy:function(n){e(t).off("resize.backstretch orientationchange.backstretch"),clearInterval(this.interval),n||this.$wrap.remove(),this.$container.removeData("backstretch")}};var o=function(){var e=navigator.userAgent,n=navigator.platform,i=e.match(/AppleWebKit\/([0-9]+)/),a=!!i&&i[1],o=e.match(/Fennec\/([0-9]+)/),s=!!o&&o[1],r=e.match(/Opera Mobi\/([0-9]+)/),l=!!r&&r[1],d=e.match(/MSIE ([0-9]+)/),c=!!d&&d[1];return!((n.indexOf("iPhone")>-1||n.indexOf("iPad")>-1||n.indexOf("iPod")>-1)&&a&&534>a||t.operamini&&"[object OperaMini]"==={}.toString.call(t.operamini)||r&&7458>l||e.indexOf("Android")>-1&&a&&533>a||s&&6>s||"palmGetResource"in t&&a&&534>a||e.indexOf("MeeGo")>-1&&e.indexOf("NokiaBrowser/8.5.0")>-1||c&&6>=c)}()}(jQuery,window),!function(){"use strict";function e(e){function t(t,i){var o,f,g=t==window,_=i&&void 0!==i.message?i.message:void 0;if(i=e.extend({},e.blockUI.defaults,i||{}),!i.ignoreIfBlocked||!e(t).data("blockUI.isBlocked")){if(i.overlayCSS=e.extend({},e.blockUI.defaults.overlayCSS,i.overlayCSS||{}),o=e.extend({},e.blockUI.defaults.css,i.css||{}),i.onOverlayClick&&(i.overlayCSS.cursor="pointer"),f=e.extend({},e.blockUI.defaults.themedCSS,i.themedCSS||{}),_=void 0===_?i.message:_,g&&p&&n(window,{fadeOut:0}),_&&"string"!=typeof _&&(_.parentNode||_.jquery)){var v=_.jquery?_[0]:_,b={};e(t).data("blockUI.history",b),b.el=v,b.parent=v.parentNode,b.display=v.style.display,b.position=v.style.position,b.parent&&b.parent.removeChild(v)}e(t).data("blockUI.onUnblock",i.onUnblock);var y,$,k,w,C=i.baseZ;y=e(c||i.forceIframe?'<iframe class="blockUI" style="z-index:'+C++ +';display:none;border:none;margin:0;padding:0;position:absolute;width:100%;height:100%;top:0;left:0" src="'+i.iframeSrc+'"></iframe>':'<div class="blockUI" style="display:none"></div>'),$=e(i.theme?'<div class="blockUI blockOverlay ui-widget-overlay" style="z-index:'+C++ +';display:none"></div>':'<div class="blockUI blockOverlay" style="z-index:'+C++ +';display:none;border:none;margin:0;padding:0;width:100%;height:100%;top:0;left:0"></div>'),i.theme&&g?(w='<div class="blockUI '+i.blockMsgClass+' blockPage ui-dialog ui-widget ui-corner-all" style="z-index:'+(C+10)+';display:none;position:fixed">',i.title&&(w+='<div class="ui-widget-header ui-dialog-titlebar ui-corner-all blockTitle">'+(i.title||"&nbsp;")+"</div>"),w+='<div class="ui-widget-content ui-dialog-content"></div>',w+="</div>"):i.theme?(w='<div class="blockUI '+i.blockMsgClass+' blockElement ui-dialog ui-widget ui-corner-all" style="z-index:'+(C+10)+';display:none;position:absolute">',i.title&&(w+='<div class="ui-widget-header ui-dialog-titlebar ui-corner-all blockTitle">'+(i.title||"&nbsp;")+"</div>"),w+='<div class="ui-widget-content ui-dialog-content"></div>',w+="</div>"):w=g?'<div class="blockUI '+i.blockMsgClass+' blockPage" style="z-index:'+(C+10)+';display:none;position:fixed"></div>':'<div class="blockUI '+i.blockMsgClass+' blockElement" style="z-index:'+(C+10)+';display:none;position:absolute"></div>',k=e(w),_&&(i.theme?(k.css(f),k.addClass("ui-widget-content")):k.css(o)),i.theme||$.css(i.overlayCSS),$.css("position",g?"fixed":"absolute"),(c||i.forceIframe)&&y.css("opacity",0);var x=[y,$,k],M=e(g?"body":t);e.each(x,function(){this.appendTo(M)}),i.theme&&i.draggable&&e.fn.draggable&&k.draggable({handle:".ui-dialog-titlebar",cancel:"li"});var U=m&&(!e.support.boxModel||e("object,embed",g?null:t).length>0);if(u||U){if(g&&i.allowBodyStretch&&e.support.boxModel&&e("html,body").css("height","100%"),(u||!e.support.boxModel)&&!g)var I=l(t,"borderTopWidth"),T=l(t,"borderLeftWidth"),S=I?"(0 - "+I+")":0,D=T?"(0 - "+T+")":0;e.each(x,function(e,t){var n=t[0].style;if(n.position="absolute",2>e)g?n.setExpression("height","Math.max(document.body.scrollHeight, document.body.offsetHeight) - (jQuery.support.boxModel?0:"+i.quirksmodeOffsetHack+') + "px"'):n.setExpression("height",'this.parentNode.offsetHeight + "px"'),g?n.setExpression("width",'jQuery.support.boxModel && document.documentElement.clientWidth || document.body.clientWidth + "px"'):n.setExpression("width",'this.parentNode.offsetWidth + "px"'),D&&n.setExpression("left",D),S&&n.setExpression("top",S);else if(i.centerY)g&&n.setExpression("top",'(document.documentElement.clientHeight || document.body.clientHeight) / 2 - (this.offsetHeight / 2) + (blah = document.documentElement.scrollTop ? document.documentElement.scrollTop : document.body.scrollTop) + "px"'),n.marginTop=0;else if(!i.centerY&&g){var a=i.css&&i.css.top?parseInt(i.css.top,10):0,o="((document.documentElement.scrollTop ? document.documentElement.scrollTop : document.body.scrollTop) + "+a+') + "px"';n.setExpression("top",o)}})}if(_&&(i.theme?k.find(".ui-widget-content").append(_):k.append(_),(_.jquery||_.nodeType)&&e(_).show()),(c||i.forceIframe)&&i.showOverlay&&y.show(),i.fadeIn){var N=i.onBlock?i.onBlock:d,O=i.showOverlay&&!_?N:d,F=_?N:d;i.showOverlay&&$._fadeIn(i.fadeIn,O),_&&k._fadeIn(i.fadeIn,F)}else i.showOverlay&&$.show(),_&&k.show(),i.onBlock&&i.onBlock();if(a(1,t,i),g?(p=k[0],h=e(i.focusableElements,p),i.focusInput&&setTimeout(s,20)):r(k[0],i.centerX,i.centerY),i.timeout){var L=setTimeout(function(){g?e.unblockUI(i):e(t).unblock(i)},i.timeout);e(t).data("blockUI.timeout",L)}}}function n(t,n){var o,s=t==window,r=e(t),l=r.data("blockUI.history"),d=r.data("blockUI.timeout");d&&(clearTimeout(d),r.removeData("blockUI.timeout")),n=e.extend({},e.blockUI.defaults,n||{}),a(0,t,n),null===n.onUnblock&&(n.onUnblock=r.data("blockUI.onUnblock"),r.removeData("blockUI.onUnblock"));var c;c=s?e("body").children().filter(".blockUI").add("body > .blockUI"):r.find(">.blockUI"),n.cursorReset&&(c.length>1&&(c[1].style.cursor=n.cursorReset),c.length>2&&(c[2].style.cursor=n.cursorReset)),s&&(p=h=null),n.fadeOut?(o=c.length,c.stop().fadeOut(n.fadeOut,function(){0===--o&&i(c,l,n,t)})):i(c,l,n,t)}function i(t,n,i,a){var o=e(a);if(!o.data("blockUI.isBlocked")){t.each(function(){this.parentNode&&this.parentNode.removeChild(this)}),n&&n.el&&(n.el.style.display=n.display,n.el.style.position=n.position,n.parent&&n.parent.appendChild(n.el),o.removeData("blockUI.history")),o.data("blockUI.static")&&o.css("position","static"),"function"==typeof i.onUnblock&&i.onUnblock(a,i);var s=e(document.body),r=s.width(),l=s[0].style.width;s.width(r-1).width(r),s[0].style.width=l}}function a(t,n,i){var a=n==window,s=e(n);if((t||(!a||p)&&(a||s.data("blockUI.isBlocked")))&&(s.data("blockUI.isBlocked",t),a&&i.bindEvents&&(!t||i.showOverlay))){var r="mousedown mouseup keydown keypress keyup touchstart touchend touchmove";t?e(document).bind(r,i,o):e(document).unbind(r,o)}}function o(t){if("keydown"===t.type&&t.keyCode&&9==t.keyCode&&p&&t.data.constrainTabKey){var n=h,i=!t.shiftKey&&t.target===n[n.length-1],a=t.shiftKey&&t.target===n[0];if(i||a)return setTimeout(function(){s(a)},10),!1}var o=t.data,r=e(t.target);return r.hasClass("blockOverlay")&&o.onOverlayClick&&o.onOverlayClick(t),r.parents("div."+o.blockMsgClass).length>0?!0:0===r.parents().children().filter("div.blockUI").length}function s(e){if(h){var t=h[e===!0?h.length-1:0];t&&t.focus()}}function r(e,t,n){var i=e.parentNode,a=e.style,o=(i.offsetWidth-e.offsetWidth)/2-l(i,"borderLeftWidth"),s=(i.offsetHeight-e.offsetHeight)/2-l(i,"borderTopWidth");t&&(a.left=o>0?o+"px":"0"),n&&(a.top=s>0?s+"px":"0")}function l(t,n){return parseInt(e.css(t,n),10)||0}e.fn._fadeIn=e.fn.fadeIn;var d=e.noop||function(){},c=/MSIE/.test(navigator.userAgent),u=/MSIE 6.0/.test(navigator.userAgent)&&!/MSIE 8.0/.test(navigator.userAgent),m=(document.documentMode||0,e.isFunction(document.createElement("div").style.setExpression));e.blockUI=function(e){t(window,e)},e.unblockUI=function(e){n(window,e)},e.growlUI=function(t,n,i,a){var o=e('<div class="growlUI"></div>');t&&o.append("<h1>"+t+"</h1>"),n&&o.append("<h2>"+n+"</h2>"),void 0===i&&(i=3e3);var s=function(t){t=t||{},e.blockUI({message:o,fadeIn:"undefined"!=typeof t.fadeIn?t.fadeIn:700,fadeOut:"undefined"!=typeof t.fadeOut?t.fadeOut:1e3,timeout:"undefined"!=typeof t.timeout?t.timeout:i,centerY:!1,showOverlay:!1,onUnblock:a,css:e.blockUI.defaults.growlCSS})};s(),o.css("opacity"),o.mouseover(function(){s({fadeIn:0,timeout:3e4});var t=e(".blockMsg");t.stop(),t.fadeTo(300,1)}).mouseout(function(){e(".blockMsg").fadeOut(1e3)})},e.fn.block=function(n){if(this[0]===window)return e.blockUI(n),this;var i=e.extend({},e.blockUI.defaults,n||{});return this.each(function(){var t=e(this);i.ignoreIfBlocked&&t.data("blockUI.isBlocked")||t.unblock({fadeOut:0})}),this.each(function(){"static"==e.css(this,"position")&&(this.style.position="relative",e(this).data("blockUI.static",!0)),this.style.zoom=1,t(this,n)})},e.fn.unblock=function(t){return this[0]===window?(e.unblockUI(t),this):this.each(function(){n(this,t)})},e.blockUI.version=2.66,e.blockUI.defaults={message:"<h1>Please wait...</h1>",title:null,draggable:!0,theme:!1,css:{padding:0,margin:0,width:"30%",top:"40%",left:"35%",textAlign:"center",color:"#000",border:"3px solid #aaa",backgroundColor:"#fff",cursor:"wait"},themedCSS:{width:"30%",top:"40%",left:"35%"},overlayCSS:{backgroundColor:"#000",opacity:.6,cursor:"wait"},cursorReset:"default",growlCSS:{width:"350px",top:"10px",left:"",right:"10px",border:"none",padding:"5px",opacity:.6,cursor:"default",color:"#fff",backgroundColor:"#000","-webkit-border-radius":"10px","-moz-border-radius":"10px","border-radius":"10px"},iframeSrc:/^https/i.test(window.location.href||"")?"javascript:false":"about:blank",forceIframe:!1,baseZ:1e3,centerX:!0,centerY:!0,allowBodyStretch:!0,bindEvents:!0,constrainTabKey:!0,fadeIn:200,fadeOut:400,timeout:0,showOverlay:!0,focusInput:!0,focusableElements:":input:enabled:visible",onBlock:null,onUnblock:null,onOverlayClick:null,quirksmodeOffsetHack:4,blockMsgClass:"blockMsg",ignoreIfBlocked:!1};var p=null,h=[]}"function"==typeof define&&define.amd&&define.amd.jQuery?define(["jquery"],e):e(jQuery)}();var MMDChat=function(){function e(e,t,n){var i=$("#monk_alert_model .modal-header"),a=$("#monk_alert_model .modal-body"),o=$("#monk_alert_model .modal-footer");void 0==e?i.addClass("hidden"):(i.html(e),i.removeClass("hidden")),void 0==t?a.addClass("hidden"):(a.html(t),a.removeClass("hidden")),void 0==n?o.addClass("hidden"):(o.html(n),o.removeClass("hidden"))}var t="http://"+window.location.host;return{alertFunc:function(t,n,i){e(t,n,i),$("#monk_alert_model").modal("show")},alertHide:function(){var e=$("#monk_alert_model");e.find(".modal-body").html(""),e.removeAttr("style"),e.modal("hide")},alertImg:function(e,t,n){var i="";i=void 0!=e?'<img id="model_img" src="'+e+'">':t,$("#monk_pic_model .modal-body").html(i),void 0==n?$("#img_foot").addClass("hidden"):$("#img_foot").removeClass("hidden");var a=document.documentElement.clientHeight;$("#monk_pic_model").height()+10>a?$("#monk_pic_model").css("top","0%"):$("#monk_pic_model").css("top","50%"),$("#monk_pic_model").modal("show")},alertImgHide:function(){var e=$("#monk_pic_model");e.find(".modal-body").html(""),e.removeAttr("style"),e.modal("hide")},saveText:function(e,n,i,a){$.post(t+"/monk/chatHis/insert_chat",{id:e,toid:n,message:i,time:a,type:"text"})},saveImage:function(e,n,i,a){$.post(t+"/monk/chatHis/insert_chat",{id:e,toid:n,message:i,time:a,type:"image"})},isMac:function(){var e=navigator.userAgent.toLowerCase();return isMac=/macintosh|mac os x|adobeair/.test(e),isMac},blockUI:function(e,t){var n={target:e};n=$.extend(!0,{},n);var i=void 0==t?"":"<span>"+t+"</span>",a='<div class="loading-message"><div class="block-spinner-bar"><div class="bounce1"></div><div class="bounce2"></div><div class="bounce3"></div></div>'+i+"</div>";if(n.target){var o=$(n.target);o.height()<=$(window).height()&&(n.cenrerY=!0),o.block({message:a,baseZ:n.zIndex?n.zIndex:10151,centerY:void 0!==n.cenrerY?n.cenrerY:!1,css:{top:"10%",border:"0",padding:"0",backgroundColor:"none"},overlayCSS:{backgroundColor:n.overlayColor?n.overlayColor:"#555",opacity:.1,cursor:"wait"}})}else $.blockUI({message:a,baseZ:n.zIndex?n.zIndex:10151,css:{border:"0",padding:"0",backgroundColor:"none"},overlayCSS:{backgroundColor:n.overlayColor?n.overlayColor:"#555",opacity:.1,cursor:"wait"}})},unblockUI:function(e){e?$(e).unblock({onUnblock:function(){$(e).css("position",""),$(e).css("zoom","")}}):$.unblockUI()}}}(),ConstantsMap={headerUrl:"",storage:window.localStorage,wsdkUrl:"https://g.alicdn.com/aliww/h5.imsdk/2.1.4/scripts/yw/wsdk.js"},MessageType={text:0,img:1,voice:2},StorageKey={imPageOpened:"imPage",initParamKey:"initParamKey",unReadMsgSum:"unReadMsgSum",isClosed:"isClosed",isFocus:"isFocus",chatWithUid:"chatWithUid",topUrl:"topUrl"},ImConstants=function(){function e(e,t){if(null!=t&&!document.getElementById(e)){var n=document.getElementsByTagName("HEAD").item(0),i=document.createElement("script");i.type="text/javascript",i.id=e,i.text=t;var a=n.getElementsByTagName("script");a.length>0?n.insertBefore(i,a[0]):n.appendChild(i)}}function t(t,n){$.ajax({type:"GET",url:n,async:!1,success:function(n){e(t,n)}})}return{checkIsTrue:function(e,t,n){var i=e.sys_id,a=e.sys_name,o=e.time,s=e.token;return void 0==i||void 0==a||void 0==o||void 0==s||""==i||""==a||""==o||""==s?(console.log("缺少必要参数"),!1):void $.get(ConstantsMap.headerUrl+"/monk/chat/checkApp",{sysId:i,sysName:a,time:o,token:s},function(e){e.success?void 0!=t&&t(e):void 0!=n&&n(e)})},getUsersData:function(e,t,n,i){$.get(ConstantsMap.headerUrl+"/monk/chat/getUser",{sysId:e,sysName:t},function(e){e.success?void 0!=n&&n(e):void 0!=i&&i(e)})},includeJs:function(e,n){t(e,n)}}}(),sId="wsdk",url=ConstantsMap.wsdkUrl;ImConstants.includeJs(sId,url);var NotifyUtil=function(){var e=3e3;return{sendNotify:function(t,n){t||n||(t="桌面提醒",n="您看到此条信息桌面提醒设置成功");var i=ConstantsMap.headerUrl+"/img/logo/im_80_80.png",a='<audio id="im_audio_mp3" autoplay="autoplay"><source src="'+ConstantsMap.headerUrl+'/img/taoqi.mp3" /></audio>';
if($("body").append(a),setTimeout(function(){$("#im_audio_mp3").remove()},1500),window.webkitNotifications)if(0==window.webkitNotifications.checkPermission()){var o=window.webkitNotifications.createNotification(i,t,n);o.display=function(){},o.onerror=function(){},o.onclose=function(){},o.onclick=function(){this.cancel()},o.replaceId="Meteoric",o.show()}else window.webkitNotifications.requestPermission(notify);else if("Notification"in window)if("granted"===Notification.permission){var s=new Notification(t,{icon:i,body:n});s.onshow=function(){setTimeout(function(){s.close()},e)}}else"denied"!==Notification.permission&&Notification.requestPermission(function(a){if("permission"in Notification||(Notification.permission=a),"granted"===a){var o=new Notification(t,{icon:i,body:n});o.onshow=function(){setTimeout(function(){o.close()},e)}}})}}}(),TimeUtil=function(){return{getTimeStringForPeople:function(e){var t=new Date,n=t;void 0!=e&&(13!=(e+"").length&&(e=1e3*parseInt(e)),n=new Date(Number(e)));var i=t.getFullYear(),a=n.getFullYear(),o=n.getMonth(),s=n.getDate(),r=n.getHours(),l=n.getMinutes();if(1==(r+"").length&&(r="0"+r),1==(l+"").length&&(l="0"+l),i==a&&t.getMonth()==o&&t.getDate()==s)return r+":"+l;var d=o+1;return 10>d&&(d="0"+d),i!=a?a+"-"+d:(10>s&&(s="0"+s),d+"-"+s)},getTimeForChat:function(e){var t=new Date,n=t.getFullYear(),i=t;void 0!=e&&(13!=(e+"").length&&(e=1e3*parseInt(e)),i=new Date(parseInt(e)));var a=i.getFullYear(),o=i.getMonth(),s=i.getDate(),r=i.getHours(),l=i.getMinutes();return 1==(r+"").length&&(r="0"+r),1==(l+"").length&&(l="0"+l),n==a&&t.getMonth()==o&&t.getDate()==s?r+":"+l:(o+=1,10>o&&(o="0"+o),10>s&&(s="0"+s),n!=a?a+"-"+o+"-"+s+" "+r+":"+l:o+"-"+s+" "+r+":"+l)},isToday:function(e){var t=new Date,n=t;void 0!=e&&(13!=(e+"").length&&(e=1e3*parseInt(e)),n=new Date(parseInt(e)));var i=n.getFullYear(),a=n.getMonth(),o=n.getDate();return t.getFullYear()==i&&t.getMonth()==a&&t.getDate()==o?!0:!1},get13Time:function(e){return 13!=(e+"").length&&(e=1e3*parseInt(e)),Number(e)}}}(),sdk=new WSDK,is_the_test=!0,online_url="im.tqmall.com",logout_func=void 0,opened_time,pageKey,param,aliUid,ali_task,is_first_yunwang,max_history_num=20,next_key_map={},new_line="monk_<br>_on",all_un_read_sum=0,this_un_read_num=0,iframe_top_map={},nowUserDO=null,beforeChangePeople_func,first_init_yunwang=!0,log_out_index=0,log_out_max_num=5,login_500=!0,retry_history_num=0,retry_send_message_num=0,retry_un_read_num=0,retry_have_read_num=0,img_data,img_fail_index=0;document.addEventListener("dragenter",function(e){e.preventDefault()},!1),document.addEventListener("dragleave",function(e){},!1),document.addEventListener("dragover",function(e){e.preventDefault()},!1),document.addEventListener("drop",function(e){e.stopPropagation(),e.preventDefault();var t=e.target.files||e.dataTransfer.files;dropHandler(t)},!1);var dropHandler=function(e){var t=$(".people_li.active").html();if(void 0==t||""==t)return void MMDChat.alertFunc("请选择一个联系人后，再进行图片拖动");for(var n=0;n<e.length;n++){var i=e[n];solveImgFile(i)}};document.addEventListener("paste",function(e){var t=$(".people_li.active").html();if(void 0==t||""==t)return void MMDChat.alertFunc("请选择一个联系人后，再进行图片黏贴");var n=e.clipboardData;if(e.clipboardData&&e.clipboardData.items)for(var i=0;i<n.items.length;i++){var a=n.items[i];if("file"==a.kind){var o=a.getAsFile();if(0===o.size)return;var s=new FileReader;s.readAsDataURL(o),s.onload=function(e){var t=e.target.result;doPic(void 0,t)}}}},!1);var is_first_wish_click=!1,HtmlUtil={section_html:'    <input type="hidden" class="init_str" id="aliuid" value="">    <input type="hidden" class="init_str" id="top_url" value=""><section class="main_chat_section"> <div class="chat_people"> <div class="header"> <i aria-hidden="true" class="icon-users"> </i> <span > 联系人列表</span> </div> <div class="search_div"><i class="fa fa-search"></i><i class="right fa fa-times-circle-o hidden" id="clear_search_people_input"></i><input type="text" id="search_people" placeholder="请输入要查找的用户名"></div><ul class="nav people_ul"> </ul> </div> <div class="welcome_content"> <div class="main_wel"> <div> <img src=ConstantsMap.headerUrl/img/logo/im_512_512.png> <span> 欢迎使用 淘汽车信</span> </div> </div> </div> <div class="chat_content hidden"> <div class="header"> <span id="chat_content_header"> </span> </div> <div class="chat_main"> <div id="loading"> </div> <div id="chat_main_div"> </div> </div> <div class="chat_input"> <div class="chat_input_div"> <div class="chat_input_util"> <span> <i class="fa fa-cut" id="cut_util"> </i> </span> <span class="file_input"> <i aria-hidden="true" class="icon-picture"> </i> <input type="file" name="pic_util" id="pic_util" multiple=""> </span> </div> <textarea id="new_message_area" placeholder="换行按Ctrl+Enter,发送消息按Enter,请输入..."> </textarea> </div> <button class="btn btn-blue" id="send_btn"> <span> 发送</span> </button> </div> <div id="expand_bottom" class="expand_bottom"> <button class="btn chat-expand-blue expand_btn"> <span class="expand_bottom_name"> 拓展</span> <i class="fa fa-angle-up"> </i> </button> </div> <div id="expand_bottom_close" class="expand_bottom expand_bottom_close hidden"> <button class="btn  expand_btn_close"> <i class="fa fa-angle-down"> </i> <span class="expand_bottom_name"> 拓展</span> </button> </div> <div style="display: none;" id="expand_main"> <iframe width="100%" style="" frameborder="no" scrolling=auto border=0 src="" id="expand_bottom_iframe" name="expand_bottom_iframe"> </iframe> </div> </div> </section> <p class="monk_chat_copyright"> <span>© 2014 - 2016 Tqmall</span><span class="sep"></span><span>ModelData</span></p>',modal_html:'<div id="monk_alert_model" class="monk_chat_modal modal fade modal-scroll" tabindex="-1" data-keyboard="false" aria-hidden="true"> <a href="#" class="model-close btn red" data-dismiss="modal" aria-hidden="true"> <i class="fa fa-times"> </i> </a> <div class="modal-section"> <div class="modal-header" > <h4 class="modal-title"> </h4> </div> <div class="modal-body"> <div class="cut_show"><div class="title"><i class="fa  fa-quote-left"></i>截图流程<i class="fa  fa-quote-right"></i></div><div><span>使用QQ等截图工具截取需要区域(可快捷键)</span><i class="fa fa-arrow-down"></i></div><div><img  src="ConstantsMap.headerUrl/img/cut/choose_cut.jpg"></div><div><span>确定截图页面</span><i class="fa fa-arrow-down"></i></div><div><img src="ConstantsMap.headerUrl/img/cut/cut.jpg"></div><div><span>鼠标点击锁定车信聊天页面</span><i class="fa fa-arrow-down"></i></div><div><img src="ConstantsMap.headerUrl/img/cut/focus_chat.jpg"></div><div><span>Ctrl+C(window)/Command+C(Mac)黏贴图片</span><i class="fa fa-check"></i></div></div></div> <div class="modal-footer" style="overflow-x: hidden;"> <button class="btn"> 发送</button> </div> </div> </div> <div id="monk_pic_model" class="monk_chat_modal modal fade modal-scroll modal_img" tabindex="-1" data-keyboard="false" aria-hidden="true"> <a href="#" class="model-close btn red" data-dismiss="modal" aria-hidden="true"> <i class="fa fa-times"> </i> </a> <div class="modal-section"> <div class="modal-body"> <img id="model_img" src=""> </div> </div> <div class="modal-footer" id="img_foot" style="overflow-x: hidden;"> <button class="btn"> 发送</button> </div> </div> ',template_html:'<script id="loading_template" type="text/html"> <div class="loading-message "> <div class="block-spinner-bar"> <div class="bounce1"> </div> <div class="bounce2"> </div> <div class="bounce3"> </div> </div> </div> </script> <script id="people_li_template" type="text/html"> {{each list as peopleVO i}} <li class="people_li" data-uid="{{peopleVO.uid}}" data-sys_id="{{peopleVO.sys_id}}" data-name="{{peopleVO.name}}" data-time="{{peopleVO.time_ns}}"> <span class="badge badge-blue">{{if peopleVO.num}}{{peopleVO.num}}{{/if}}</span> <span class="username"> {{peopleVO.nickName}} </span> <span class="final_name"> {{peopleVO.time_str}}</span> </li> {{/each}} </script> <script id="expand_top_template" type="text/html">  <div id="expand_top" class="expand_top hidden"> <a href="#" class="" id="expand_top_close">  <i class="fa fa-times"></i> </a> <iframe src="{{top_url}}" width="100%" style="" frameborder="no" scrolling=auto border=0 src="" id="expand_top_iframe" name="expand_top_iframe"></iframe> </div> </script> <script id="chat_msg_template" type="text/html"> {{each list as msgVO i}} <div data-time ={{msgVO.time_ns}} data-type={{msgVO.type}} class="chat_msg_wrap{{if msgVO.you}}  chat_l "> <img class="img-circle" src="ConstantsMap.headerUrl/img/users/you.png"> {{else}}  chat_r"> <img class="img-circle" src="ConstantsMap.headerUrl/img/users/me.png">  {{/if}} <div class="chat_msg"> <div class="chat-msg-time"> <span> {{msgVO.time_str}}</span> </div> <div class="chat-msg-inner"> <i class="chat-arr"> </i> <div class="chat-msg-item"> <pre> {{each msgVO.msg_array as value index}} {{if index != 0}} <br> {{/if}} {{if msgVO.type ==  0}} {{value}} {{else if msgVO.type ==  1}} <img src="{{value}}"> {{/if}} {{/each}} </pre> </div> <i class="fa fa-warning msg_help msg_error"></i><img  class="msg_help  msg_loading" src="ConstantsMap.headerUrl/img/other/input-spinner.gif"></img></div> </div> </div> {{/each}} </script> '},ChatUtil=function(){return{init:function(e){if(void 0==e||""==e)return console.log("header_url not be empty"),!1;document.title="淘汽车信";var t=$("body");ConstantsMap.headerUrl=e;var n=HtmlUtil.section_html+HtmlUtil.modal_html+HtmlUtil.template_html,i=/ConstantsMap.headerUrl/g;n=n.replace(i,ConstantsMap.headerUrl),t.prepend(n),MMDChat.blockUI(),backgroundReady(),initCss(),initCheck(),initClick(),windowChange()},beforeChangePeople:function(e){$.isFunction(e)&&beforeChangePeople(e)},closeChatWindow:function(){windowClose()}}}();